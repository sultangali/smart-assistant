import mongoose from 'mongoose';
import dotenv from 'dotenv';
import Admin from './models/Admin.js';

dotenv.config();

const isValidEmail = (email) => {
  if (!email || typeof email !== 'string') return false;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email.trim());
};

async function updateAdminEmail() {
  try {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ“§ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ email Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    const mongoUri = process.env.MONGODB_URI || 'mongodb://localhost:27017/smart-assistant';
    console.log('ğŸ“¡ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº MongoDB...');
    
    await mongoose.connect(mongoUri);
    console.log('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!');
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
    const admin = await Admin.findOne({ email: 'admin' });
    
    if (!admin) {
      console.error('âŒ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      process.exit(1);
    }
    
    console.log('ğŸ‘¤ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:');
    console.log(`   Email: ${admin.email}`);
    console.log(`   Notification Email: ${admin.notificationEmail || '(Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½)'}`);
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ SMTP_USER Ğ¸Ğ· .env
    const smtpUser = process.env.SMTP_USER;
    
    if (smtpUser && isValidEmail(smtpUser)) {
      console.log(`\nğŸ“§ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ notificationEmail Ğ½Ğ° ${smtpUser}...`);
      admin.notificationEmail = smtpUser;
      await admin.save();
      console.log('âœ… NotificationEmail Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!');
    } else {
      console.log('\nâš ï¸ SMTP_USER Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½ Ğ² .env Ñ„Ğ°Ğ¹Ğ»Ğµ');
      console.log('   Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ SMTP_USER Ğ² .env Ñ„Ğ°Ğ¹Ğ»Ğµ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ');
      
      // ĞŸÑ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ Ğ²Ğ²ĞµÑÑ‚Ğ¸ email Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
      const readline = await import('readline');
      const rl = readline.default.createInterface({
        input: process.stdin,
        output: process.stdout
      });
      
      const email = await new Promise((resolve) => {
        rl.question('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ): ', (answer) => {
          rl.close();
          resolve(answer.trim());
        });
      });
      
      if (email && isValidEmail(email)) {
        admin.notificationEmail = email;
        await admin.save();
        console.log('âœ… NotificationEmail Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!');
      } else if (email) {
        console.log('âŒ Ğ’Ğ²ĞµĞ´ĞµĞ½ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ email');
      } else {
        console.log('â­ï¸  ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾');
      }
    }
    
    console.log('\nğŸ“‹ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸:');
    const updatedAdmin = await Admin.findOne({ email: 'admin' });
    console.log(`   Email: ${updatedAdmin.email}`);
    console.log(`   Notification Email: ${updatedAdmin.notificationEmail || '(Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½)'}`);
    
    console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    process.exit(0);
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°:', error);
    process.exit(1);
  }
}

updateAdminEmail();

